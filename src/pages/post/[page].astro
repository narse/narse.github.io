---
export const prerender = true;

import { getCollection, type CollectionEntry } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import BlogLayout from "@layouts/BlogLayout.astro";
import FooterBlogRow from "@components/home/FooterBlogRow.astro";
import Pagination from "@components/blog/Pagination.astro";
import { SITE_TITLE } from "@/constants";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection("posts");

  // Get first 2 featured posts (shown in Hero)
  const featuredForHero = allPosts
    .filter((post) => post.data.featured)
    .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime())
    .slice(0, 2);

  // Get IDs of posts shown in Hero
  const heroPostIds = new Set(featuredForHero.map((p) => p.id));

  // All other posts (excluding Hero's 2), sorted by date
  const remainingPosts = allPosts
    .filter((post) => !heroPostIds.has(post.id))
    .sort(
      (a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime()
    );

  // Skip first 3 posts (shown on homepage), paginate the rest
  return paginate(remainingPosts.slice(3), { pageSize: 3 });
};

type Props = {
  page: Page<CollectionEntry<"posts">>;
};

const page = Astro.props.page;

// page.currentPage is 1-indexed from Astro's paginate
// Overall: homepage = page 1, /post/1 = page 2, etc.
const actualCurrentPage = page.currentPage + 1;
const totalPages = Math.ceil(page.total / page.size) + 1;

// prevUrl: /post/1 should link back to homepage
const prevUrl = page.currentPage === 1 ? "/" : page.url.prev;
---

<BlogLayout title={SITE_TITLE}>
  <FooterBlogRow posts={page.data.slice(0, 3)} />
  <Pagination
    currentPage={actualCurrentPage}
    totalPages={totalPages}
    nextUrl={page.url.next}
    prevUrl={prevUrl}
  />
</BlogLayout>
