---
export const prerender = true;

import BlogNavigation from "@components/blog/BlogNavigation.astro";
import NewsLatter from "@components/blog/NewsLatter.astro";
import TagsFooter from "@components/blog/TagsFooter.astro";
import Layout from "@layouts/Layout.astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import { GOOGLE_ADSENSE_ID } from "@/constants";

export async function getStaticPaths() {
  const blogEntries = await getCollection("posts");
  return blogEntries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Extract SEO data from post
const postTitle = entry.data.title;
const postDescription = entry.data.description || "";
const postImage = entry.data.coverImage || undefined;
const postImageAlt = entry.data.title;
const postTags = entry.data.tags || [];
const postAuthor = entry.data.author || "Admin";
const publishedTime = entry.data.publishedAt?.toISOString();
const modifiedTime = entry.data.updatedAt?.toISOString();

// Helper function to format dates in a user-friendly way
const formatDate = (date: Date | undefined) => {
  if (!date) return "Unknown date";
  return new Intl.DateTimeFormat("ko-KR", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
};

// Fetch related posts from the same category (excluding current post)
const allPosts = await getCollection("posts");
const relatedPosts = allPosts
  .filter(
    (post) =>
      post.id !== entry.id &&
      post.data.category === entry.data.category
  )
  .slice(0, 3);
---

<Layout
  title={postTitle}
  description={postDescription}
  image={postImage}
  imageAlt={postImageAlt}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  author={postAuthor}
  tags={postTags}
>
  <div class="mx-auto max-w-340 px-4 font-sans sm:px-6 lg:px-8">
    <div class="grid gap-y-8 lg:grid-cols-3 lg:gap-x-6 lg:gap-y-0">
      <!-- Content -->
      <article class="w-full lg:col-span-2">
        <div class="py-8 lg:pe-8">
          <div class="space-y-5 lg:space-y-8">
            <BlogNavigation />
            <h2 class="text-3xl font-bold lg:text-5xl">
              {entry.data.title}
            </h2>
            {
              postImage && (
                <Image
                  src={postImage}
                  alt={postImageAlt}
                  class="w-full rounded-lg"
                  width={700}
                  height={500}
                />
              )
            }

            <div class="flex items-center gap-x-5">
              <span
                class="inline-flex items-center gap-1.5 rounded-full border border-gray-300 bg-gray-100 px-3 py-1 text-xs text-gray-800 hover:bg-gray-200 focus:bg-gray-200 focus:outline-none sm:px-4 sm:py-2 sm:text-sm"
              >
                {entry.data.category || "Uncategorized"}
              </span>
              <p class="text-xs text-gray-800 sm:text-sm">
                {formatDate(entry.data.publishedAt)}
              </p>
            </div>
          </div>
        </div>
        <div class="prose mb-4 max-w-full sm:mb-6">
          <Content />

          <div class="mt-8">
            <TagsFooter tags={entry.data.tags ?? []} />
          </div>
        </div>
        <NewsLatter relatedPosts={relatedPosts} />
      </article>
      <!-- End Content -->

      <!-- Sidebar -->
      <div
        class="lg:col-span-1 lg:size-full lg:bg-linear-to-r lg:from-gray-50 lg:via-transparent lg:to-transparent"
      >
        <div class="sticky start-0 top-0 py-8 lg:ps-8">
          <!-- Author Info -->
          <div class="mb-6 flex items-center gap-4">
            <div>
              <p class="font-semibold text-gray-800">{postAuthor}</p>
              <p class="text-sm text-gray-500">{formatDate(entry.data.publishedAt)}</p>
            </div>
          </div>
          <!-- End Author Info -->

          <!-- Related Posts -->
          <h3 class="mb-4 text-lg font-semibold">관련 글</h3>
          <div class="flex flex-col gap-4 sm:gap-6">
            {relatedPosts.length > 0 ? (
              relatedPosts.map((post) => (
                <a href={`/post/${post.id}`} class="group block">
                  <h4 class="text-sm font-medium text-gray-800 group-hover:text-blue-600">
                    {post.data.title}
                  </h4>
                  <p class="mt-1 text-xs text-gray-500">
                    {formatDate(post.data.publishedAt)}
                  </p>
                </a>
              ))
            ) : (
              <p class="text-sm text-gray-500">관련 글이 없습니다.</p>
            )}
          </div>
        </div>
      </div>
      <!-- End Sidebar -->
    </div>
  </div>
</Layout>

<script>
  // Remove autoplay from videos when `prefers-reduced-motion: reduce`
  const autoplayVideos = document.querySelectorAll("video[autoplay]");
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  if (prefersReducedMotion) {
    autoplayVideos.forEach((video) => {
      video.removeAttribute("autoplay");
      video.setAttribute("controls", "true");
    });
  }

</script>

<script define:vars={{ GOOGLE_ADSENSE_ID }}>
  if (GOOGLE_ADSENSE_ID) {
    document.addEventListener("DOMContentLoaded", () => {
      const content = document.querySelector(".prose");
      if (!content) return;

      const headings = content.querySelectorAll("h2, h3");
      headings.forEach((heading, index) => {
        // Create ad container
        const adContainer = document.createElement("div");
        adContainer.className = "my-8 flex justify-center overflow-hidden";
        adContainer.innerHTML = `
          <!-- AdSense Unit -->
          <!-- IMPORTANT: Replace data-ad-slot with your actual "In-article" ad unit ID from AdSense dashboard -->
          <ins class="adsbygoogle"
               style="display:block; text-align:center; min-width: 250px;"
               data-ad-layout="in-article"
               data-ad-format="fluid"
               data-ad-client="${GOOGLE_ADSENSE_ID}"
               data-ad-slot="YOUR_AD_SLOT_ID_HERE"></ins>
        `;
        heading.after(adContainer);
        
        try {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        } catch (e) {
          console.error("AdSense error:", e);
        }
      });
    });
  }
</script>
