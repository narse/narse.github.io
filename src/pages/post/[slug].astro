---
export const prerender = true;

import AuthorCard from "@components/blog/AuthorCard.astro";
import BlogNavigation from "@components/blog/BlogNavigation.astro";
import NewsLatter from "@components/blog/NewsLatter.astro";
import RelatedBlogCard from "@components/blog/RelatedBlogCard.astro";
import StickyActionBar from "@components/blog/StickyActionBar.astro";
import TagsFooter from "@components/blog/TagsFooter.astro";
import Layout from "@layouts/Layout.astro";
import { getCollection, render, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const blogEntries = await getCollection("posts");
  return blogEntries.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Extract SEO data from post
const postTitle = entry.data.title;
const postDescription = entry.data.description || "";
const postImage = entry.data.coverImage || undefined;
const postImageAlt = entry.data.title;
const postTags =
  entry.data.tags?.map((tag: { name: string }) => tag.name) || [];
const postAuthor = entry.data.authors?.[0]?.name || "";
const publishedTime = entry.data.publishedAt?.toISOString();
const modifiedTime = entry.data.updatedAt?.toISOString();

let relatedPosts: CollectionEntry<"posts">[] = [];
---

<Layout
  title={postTitle}
  description={postDescription}
  image={postImage}
  imageAlt={postImageAlt}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  author={postAuthor}
  tags={postTags}
>
  <div class="mx-auto max-w-340 px-4 font-sans sm:px-6 lg:px-8">
    <div class="grid gap-y-8 lg:grid-cols-3 lg:gap-x-6 lg:gap-y-0">
      <!-- Content -->
      <article class="w-full lg:col-span-2">
        <div class="py-8 lg:pe-8">
          <div class="space-y-5 lg:space-y-8">
            <BlogNavigation />
            <h2
              class="text-3xl font-bold lg:text-5xl"
              transition:name={entry.data.title}
            >
              {entry.data.title}
            </h2>

            <div class="flex items-center gap-x-5">
              <span
                class="inline-flex items-center gap-1.5 rounded-full border border-gray-300 bg-gray-100 px-3 py-1 text-xs text-gray-800 hover:bg-gray-200 focus:bg-gray-200 focus:outline-none sm:px-4 sm:py-2 sm:text-sm"
              >
                {entry.data.category.name}
              </span>
              <p class="text-xs text-gray-800 sm:text-sm">
                {entry.data.publishedAt.toISOString().substring(0, 10)}
              </p>
            </div>
          </div>
        </div>
        <div class="prose mb-4 max-w-full sm:mb-6">
          <Content />

          <div class="mt-8">
            <TagsFooter tags={entry.data.tags ?? []} />
          </div>
        </div>
        <NewsLatter />
      </article>
      <!-- End Content -->

      <!-- Sidebar -->
      <div
        class="lg:col-span-1 lg:size-full lg:bg-linear-to-r lg:from-gray-50 lg:via-transparent lg:to-transparent"
      >
        <div class="sticky start-0 top-0 py-8 lg:ps-8">
          <!-- Avatar Media -->
          <AuthorCard post={entry} />
          <!-- End Avatar Media -->

          <div class="flex flex-col gap-4 sm:gap-6">
            {relatedPosts.map((post) => <RelatedBlogCard post={post} />)}
          </div>
        </div>
      </div>
      <!-- End Sidebar -->
    </div>
  </div>
  <StickyActionBar post={entry} />
</Layout>

<script>
  // Remove autoplay from videos when `prefers-reduced-motion: reduce`
  const autoplayVideos = document.querySelectorAll("video[autoplay]");
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  if (prefersReducedMotion) {
    autoplayVideos.forEach((video) => {
      video.removeAttribute("autoplay");
      // Add controls attribute so user can still play the video if they want
      video.setAttribute("controls", "true");
    });
  }
</script>
